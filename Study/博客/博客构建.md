## 1.构建后端API

### 后台项目地址

https://github.com/byteblogs168/plumemo

在本地或服务器上创建数据库hello_blog，启动项目会自动建表，建表语句在项目中，可自行修改。

### 使用docker部署

docker与docker-compose的安装配置需自行解决

将Dockerfile、docker-compose.yml、打包好的后台项目jar包上传到服务器某个目录下，需注意创建挂载的目录

这里需要将后台项目mysql的url的ip地址改成容器名称，如：jdbc:mysql://imysql:3306/hello_blog

#### my.cnf

mysql配置文件

```ini
[mysqld]
port=3306
pid-file        = /var/run/mysqld/mysqld.pid
socket          = /var/run/mysqld/mysqld.sock
datadir         = /var/lib/mysql
#log-error      = /var/log/mysql/error.log
# By default we only accept connections from localhost
#bind-address   = 127.0.0.1
# Disabling symbolic-links is recommended to prevent assorted security risks
symbolic-links=0
sql_mode=STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION
```



#### Dockerfile

```dockerfile
FROM java:8

MAINTAINER test

COPY *.jar app.jar

# 运行jar包

EXPOSE 8086

ENTRYPOINT ["java","-jar","/app.jar"]
```

#### docker-compose.yml

```yml
version: '3'
services:
  plumemo-blog-server:
    image: plumemo-blog-server:v1.0 #设定镜像与tag
    container_name: plumemo-blog-server
    restart: always
    build: .
    environment:
      TZ: Asia/Shanghai # 指定时区
    ports:
      - "8086:8086"
    volumes:
      - /home/blog/server/app/logs:/logs
    depends_on:
      - mysql
  imysql:
    restart: always
    image: mysql:5.7
    container_name: imysql
    volumes:
      - /home/blog/server/mysql/config/datadir:/var/lib/mysql
      - /home/blog/server/mysql/config/conf/my.cnf:/etc/mysql/mysql.conf.d/mysqld.cnf
    environment:
      TZ: Asia/Shanghai
    ports:
      - 3306:3306
```

上传完毕后，执行

```
docker-compose up -d
```

mysql可能需要开启远程访问，可百度解决，如果修改了后端项目，更新的时候记得先删除镜像再启动。

## 2.构建前台项目

### 前台项目地址

博客项目

https://gitee.com/baiyangc/nuxt-blog

后台管理系统

https://github.com/byteblogs168/plumemo-admin

### 使用docker部署

将整个博客项目拷贝到服务器，后台管理系统只需要在本地打包（npm run build）将打包后的dist文件夹上传即可。

**注意：**博客页面需将nuxt.config.js下的proxy下的pathrewrite注释掉，因为已经由nginx代理转发了

#### Dockerfile

```dockerfile
FROM node:14.17.4

MAINTAINER Huanghai

ENV NODE_ENV=production

ENV HOST 0.0.0.0

RUN mkdir -p /app

WORKDIR /app

COPY nuxt-blog . #nuxt-blog这个目录就是你项目根目录

EXPOSE 3000

#此为cnpm淘宝镜像
RUN npm config set registry https://registry.npm.taobao.org

RUN npm install

RUN npm run build

CMD ["npm", "start"]
```

#### docker-compose.yml

```yml
version: '3'
services:
   mynginx:
    #主机名
    container_name: mynginx
    image: nginx:1.16.1
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - /home/blog/client/plumemo-admin:/home/blog/plumemo-admin #打包后的项目文件
      - /home/blog/client/nginx/nginx.conf:/etc/nginx/nginx.conf 
      - ./nginx/logs:/var/log/nginx
      - /root/card:/root/card #https证书路径
    restart: always
   nuxt-blog:
    image: nuxt-blog:v1.0 #设定镜像与tag
    container_name: nuxt-blog
    restart: always
    build: .
    environment:
      TZ: Asia/Shanghai # 指定时区
    ports:
      - "3000:3000"
```

#### nginx.config

```nginx

user  root;
worker_processes  1;

events {
    worker_connections  4096;
}

http {
    include       mime.types;
    default_type  application/octet-stream;
	proxy_set_header       X-Real-IP $remote_addr;
	proxy_set_header       X-Forwarded-For $proxy_add_x_forwarded_for;
	proxy_set_header       X-Forwarded-For $http_x_forwarded_for;
	proxy_headers_hash_max_size 1024;
	proxy_headers_hash_bucket_size  128;

    sendfile        on;
	
    keepalive_timeout  65;

	server {
		listen  443;
		server_name www.djttfor.cn djttfor.cn;
		ssl on;
		ssl_certificate  /root/card/djttfor.cn.pem;
		ssl_certificate_key /root/card/djttfor.cn.key;
		
		location / {
			proxy_http_version 1.1;
			proxy_set_header Upgrade $http_upgrade;  
			proxy_set_header Connection "upgrade";
			proxy_set_header Host $host;
			proxy_set_header X-Nginx-Proxy true;
			proxy_cache_bypass $http_upgrade;
			proxy_pass http://nuxt-blog:3000;
		}#博客页面
			
		location /admin {
			root /home/blog/plumemo-admin;
			index index.html index.htm;
			try_files $uri $uri/ /admin/index.html;
		}#后台管理系统
		
		
		location ^~ /api/blog {
			index  index.html index.htm index.php;
			index  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
			index  proxy_set_header Host $host;
			index  proxy_set_header X-Real-IP $remote_addr;
			proxy_pass http://106.55.6.73:8086/api/plumemo-service;  
		}#后台接口，配置upstream即可
	}
	server {
		listen 80;
		server_name www.djttfor.cn djttfor.cn;
		#将请求转成https
		rewrite ^(.*)$ https://$host$1 permanent;
    }
}
```

上传完毕后,执行

```
docker-compose up -d
```

